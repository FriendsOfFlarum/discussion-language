/*! For license information please see forum.js.LICENSE.txt */
(()=>{var t={879:t=>{t.exports=function(t){for(var e=[],a=0,o=0,n=0,s=t.length;n<s;)a=t.charCodeAt(n++),o?(e.push((65536+(o-55296<<10)+(a-56320)).toString(16)),o=0):55296<=a&&a<=56319?o=a:e.push(a.toString(16));return e.join("-")}}},e={};function a(o){var n=e[o];if(void 0!==n)return n.exports;var s=e[o]={exports:{}};return t[o](s,s.exports,a),s.exports}a.n=t=>{var e=t&&t.__esModule?()=>t.default:()=>t;return a.d(e,{a:e}),e},a.d=(t,e)=>{for(var o in e)a.o(e,o)&&!a.o(t,o)&&Object.defineProperty(t,o,{enumerable:!0,get:e[o]})},a.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),a.r=t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})};var o={};(()=>{"use strict";a.r(o),a.d(o,{components:()=>et,models:()=>ot,utils:()=>at});const t=flarum.core.compat["common/Model"];var e=a.n(t);const n=flarum.core.compat["common/models/Forum"];var s=a.n(n);const r=flarum.core.compat["tags/common/models/Tag"];var i=a.n(r);const u=flarum.core.compat["common/models/Discussion"];var c=a.n(u);function l(t,e){return l=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t},l(t,e)}function p(t,e){t.prototype=Object.create(e.prototype),t.prototype.constructor=t,l(t,e)}var g=function(t){function a(){for(var a,o=arguments.length,n=new Array(o),s=0;s<o;s++)n[s]=arguments[s];return(a=t.call.apply(t,[this].concat(n))||this).code=e().attribute("code"),a.country=e().attribute("country"),a.name=e().attribute("name"),a.emoji=e().attribute("emoji"),a}return p(a,t),a.prototype.apiEndpoint=function(){return"/fof/discussion-language"+(this.exists?"/"+this.data.id:"")},a}(e());const f=flarum.core.compat["common/extend"],d=flarum.core.compat["forum/utils/DiscussionControls"];var h=a.n(d);const v=flarum.core.compat["common/components/Button"];var y=a.n(v);const b=flarum.core.compat["common/components/Modal"];var L=a.n(b);const x=flarum.core.compat["forum/components/DiscussionPage"];var D=a.n(x);const _=flarum.core.compat["common/Component"];var w=a.n(_),C=a(879),P=a.n(C);const S=flarum.core.compat["common/helpers/icon"];var j=a.n(S);const O=function(t){if(t){var e=t.emoji?t.emoji():t;return e?m("img",{alt:t.country&&t.country()||"",className:"emoji",draggable:"false",loading:"lazy",src:"//cdn.jsdelivr.net/gh/twitter/twemoji@13/assets/72x72/"+P()(e)+".png"}):j()("fas fa-globe")}};var B=function(t){function e(){return t.apply(this,arguments)||this}p(e,t);var a=e.prototype;return a.oninit=function(e){t.prototype.oninit.call(this,e),this.languages=app.store.all("discussion-languages"),this.options=this.languages.reduce((function(t,e){return t[e.code()]=m("span",null,O(e)," ",e.name()),t}),this.attrs.extra||{})},a.view=function(){var t=this.attrs,e=t.language,a=t.uppercase,o=e.name()||"";return m("span",null,O(e),"Â ",a?o.toUpperCase():o)},e}(w()),N=function(t){function e(){return t.apply(this,arguments)||this}p(e,t);var a=e.prototype;return a.oninit=function(e){t.prototype.oninit.call(this,e),this.languages=app.store.all("discussion-languages"),this.current=this.attrs.selected||this.attrs.discussion&&this.attrs.discussion.language(),this.selected=this.current},a.className=function(){return"FoFLanguageDiscussionModal"},a.title=function(){return this.attrs.discussion?app.translator.trans("fof-discussion-language.forum.change_language.edit_title",{title:m("em",null,this.attrs.discussion.title())}):app.translator.trans("fof-discussion-language.forum.change_language.title")},a.content=function(){var t=this;return[m("div",{className:"Modal-body"},m("div",{className:"Form-group"},this.languages.map((function(e){return m(y(),{onclick:t.select.bind(t,e),className:"Button Button--block "+(t.selected===e?"active":"")},m(B,{language:e,uppercase:!0}))}))),!this.attrs.hideSubmitButton&&m("div",{className:"App-primaryControl"},y().component({type:"submit",className:"Button Button--primary",disabled:!this.selected||this.selected===this.current,loading:this.loading,icon:"fas fa-check"},app.translator.trans("fof-discussion-language.forum.change_language.submit_button"))))]},a.select=function(t){if(this.selected=t,this.attrs.hideSubmitButton)return this.onsubmit();m.redraw()},a.onsubmit=function(t){var e=this;t&&t.preventDefault();var a=this.attrs,o=a.discussion,n=a.onsubmit;if(this.loading=!0,!o)return this.hide(),void(n&&n(this.selected));var s=this.selected;o.save({relationships:{language:s}}).then((function(){return app.current instanceof D()&&app.current.stream.update(),e.hide()})).catch(this.loaded.bind(this))},e}(L());const k=flarum.core.compat["common/app"];var M=a.n(k);const A=flarum.core.compat["forum/components/IndexPage"];var q=a.n(A);const F=flarum.core.compat["forum/components/DiscussionComposer"];var I=a.n(F),T=function(t,e){return t.code().toLowerCase()>e.code().toLowerCase()};const z=flarum.core.compat["forum/components/DiscussionHero"];var R=a.n(z);const E=flarum.core.compat["forum/states/DiscussionListState"];var G=a.n(E);const H=flarum.core.compat["forum/components/DiscussionListItem"];var U=a.n(H);const W=flarum.core.compat["forum/states/GlobalSearchState"];var $=a.n(W);const J=flarum.core.compat["common/utils/setRouteWithForcedRefresh"];var K=a.n(J);const Q=flarum.core.compat["forum/app"];var V=a.n(Q);const X=flarum.core.compat["common/components/SelectDropdown"];var Y=a.n(X),Z=function(t){function e(){return t.apply(this,arguments)||this}p(e,t);var a=e.prototype;return a.oninit=function(e){t.prototype.oninit.call(this,e),this.languages=V().store.all("discussion-languages"),this.options=this.languages.reduce((function(t,e){return t[e.code()]=m(B,{language:e}),t}),this.attrs.extra||{})},a.view=function(){var t=this,e=V().forum.attribute("fof-discussion-language.showAnyLangOpt")?"any":V().translator.formatter.locale;return m(Y(),{buttonClassName:"Button"},Object.keys(this.options).map((function(a){var o,n=t.attrs.selected?a===t.attrs.selected:a===e;return m(y(),{active:n,icon:!n||"fas fa-check",onclick:null==(o=t.attrs.onclick)||null==o.bind?void 0:o.bind(t,a)},t.options[a])})))},e}(w()),tt=function(t){var e,a;if(null==(e=(a=this.attrs.discussion).isPrivateDiscussion)||!e.call(a)){var o=this.attrs.discussion.language();o&&t.add("discussion-language",m("span",null,O(o)||m("i",{className:"fas fa-globe"}),m("code",null,o.name())),5)}},et={Language:B,LanguageDiscussionModal:N,LanguageDropdown:Z},at={flag:O},ot={Language:g};app.initializers.add("fof/discussion-language",(function(){app.store.models["discussion-languages"]=g,"flarum-tags"in flarum.extensions&&(i().prototype.localisedLastDiscussion=e().attribute("localisedLastDiscussion")),s().prototype.discussionLanguages=e().hasMany("discussionLanguages"),c().prototype.language=e().hasOne("language"),c().prototype.canChangeLanguage=e().attribute("canChangeLanguage"),(0,f.extend)(h(),"moderationControls",(function(t,e){e.canChangeLanguage()&&t.add("language",y().component({icon:"fas fa-globe",onclick:function(){return app.modal.show(N,{discussion:e})}},app.translator.trans("fof-discussion-language.forum.discussion_controls.change_language_button")))})),(0,f.extend)(q().prototype,"newDiscussionAction",(function(t){var e=M().search.params().language;if(e)t.then((function(t){return t.fields.language=M().store.getBy("discussion-languages","code",e)}));else{var a=M().forum.attribute("fof-discussion-language.composerLocaleDefault");M().composer.fields.language=a?M().store.getBy("discussion-languages","code",M().translator.formatter.locale):""}})),I().prototype.chooseLanguage=function(t,e){var a=this;M().modal.show(N,{selected:this.composer.fields.language,hideSubmitButton:t,onsubmit:function(t){a.composer.fields.language=t,a.$("textarea").focus(),e&&e()}})},(0,f.extend)(I().prototype,"headerItems",(function(t){this._isByobuComposer||t.add("language",m("a",{className:"DiscussionComposer-changeTags",onclick:this.chooseLanguage.bind(this,!0,null)},m("span",{className:"LanguageLabel "+(this.composer.fields.language?"":"none")},this.composer.fields.language?B.component({language:this.composer.fields.language,uppercase:!0}):M().translator.trans("fof-discussion-language.forum.composer_discussion.choose_language_link"))),20)})),(0,f.override)(I().prototype,"onsubmit",(function(t){return this._isByobuComposer?t():this.composer.fields.language?void t():this.chooseLanguage(!0,t)})),(0,f.extend)(I().prototype,"data",(function(t){this._isByobuComposer||(t.relationships=t.relationships||{},t.relationships.language=this.composer.fields.language||M().store.all("discussion-languages").sort(T)[0])})),(0,f.extend)(U().prototype,"infoItems",tt),(0,f.extend)(R().prototype,"items",tt),(0,f.extend)(G().prototype,"requestParams",(function(t){var e,a=app.current.data.routeName;if("byobuPrivate"!==a&&(t.include.push("language"),"user.discussions"!==a)){"following"===a&&t.filter.q&&(t.filter.q+=" is:"+(t.filter.subscription||"following"),delete t.filter.subscription);var o=app.search.params().language,n=null!=(e=app.search.params().language)?e:app.translator.formatter.locale;t.filter.q?app.forum.attribute("fof-discussion-language.showAnyLangOpt")?app.serach.params().language&&(t.filter.q+=" language:"+o):t.filter.q+=" language:"+n:t.filter.language=n}})),(0,f.extend)($().prototype,"stickyParams",(function(t){return t.language=m.route.param("language")})),(0,f.extend)(q().prototype,"viewItems",(function(t){var e,a;"byobuPrivate"!==app.current.data.routeName&&(app.forum.attribute("fof-discussion-language.showAnyLangOpt")?(e={any:app.translator.trans("fof-discussion-language.forum.index_language.any")},a="any"):a=app.translator.formatter.locale,t.add("language",Z.component({extra:e,default:a,onclick:function(t){var e=app.search.params();t===a?delete e.language:e.language=t,K()(app.route(app.current.get("routeName"),e))},selected:app.search.params().language})))})),"flarum-tags"in flarum.extensions&&(i().prototype.lastPostedDiscussion=function(){var t,a,o,n=e().hasOne("lastPostedDiscussion").bind(this);if(!V().forum.attribute("fof-discussion-language.useLocaleForTagsPageLastDiscussion"))return n();var s=this.localisedLastDiscussion(),r=(null==(t=V().session.user)||null==t.preferences||null==(a=t.preferences())?void 0:a.locale)||V().translator.formatter.locale||V().forum.discussionLanguages()[0].code(),i=null==(o=V().forum.discussionLanguages().find((function(t){return t.code()===r})))?void 0:o.id();if(!i)return n();var u=s[i];return u?new(c())({attributes:{title:u.title,slug:u.id,lastPostedAt:new Date(1e3*u.at).toISOString()}}):n()})}))})(),module.exports=o})();
//# sourceMappingURL=forum.js.map